<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>UPP: 2-D Decomposition Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">UPP
   &#160;<span id="projectnumber">V11.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_2D-decomp.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">2-D Decomposition Overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Author:</b> George Vandenberghe</p>
<p><b>Date:</b> June 2022</p>
<h2>Comparison of 1D vs. 2D Decomposition</h2>
<p>The 1D decomposition can read state from a model forecast file, either by reading on rank 0 and scattering, or by doing MPI_IO on the model history file using either nemsio, sigio, or netcdf serial or parallel I/O. Very old post tags also implement the more primitive full state broadcast or (a performance bug rectified 10/17) read the entire state on all tasks. This is mentioned in case a very old tag is encountered.</p>
<p>The 2D decomposition only supports MPI_IO, namely NetCDF Parallel I/O. But the code is backwards compatible and all I/O methods remain supported for the 1D decomposition cases and works for all cases currently supported by older 1D tags and branches.</p>
<h2>2D Decomposition Design</h2>
<p>The 2D decomposition operates on subdomains with some latitudes and some longitudes. The subdomains are lon-lat rectangles rather than strips. This means state must be chopped into pieces in any scatter operation and the pieces reassembled in any gather operation that requires a continuous in memory state. I/O and halo exchanges both require significantly more bookkeeping.</p>
<p>The structural changes needed for the 2D decomposition are implemented in <a class="el" href="MPI__FIRST_8f.html">MPI_FIRST.f</a> and <a class="el" href="CTLBLK_8f_source.html">CTLBLK.f</a>. The <a class="el" href="CTLBLK_8f_source.html">CTLBLK.f</a> routine contains numerous additional variables describing left and right domain boundaries. Many additional changes are also implemented in <a class="el" href="EXCH_8f.html" title="Subroutines that exchange one halo row. ">EXCH.f</a> to support 2D halos. Many additional routines required addition of the longitude subdomain limits but changes to the layouts are handled in <a class="el" href="CTLBLK_8f_source.html">CTLBLK.f</a> and the "many additional routines" do not require additional changes when subdomain shapes are changed and have not been a trouble point.</p>
<p>Both <a class="el" href="MPI__FIRST_8f.html">MPI_FIRST.f</a> and <a class="el" href="EXCH_8f.html" title="Subroutines that exchange one halo row. ">EXCH.f</a> contain significant additional test code to exchange arrays containing grid coordinates and ensure EXACT matches for all exchanges before the domain exchanges are performed. This is intended to trap errors in the larger variety of 2D decomposition layouts that are possible and most of it can eventually be removed or made conditional at build and run time.</p>
<p>The following is found in <a class="el" href="CTLBLK_8f_source.html">CTLBLK.f</a> and shared in the rest of UPP through use of CTLBLK.mod:</p>
<table class="doxtable">
<tr>
<th>Variable </th><th>Type </th><th>Description  </th></tr>
<tr>
<td>im </td><td>integer </td><td>full longitude domain </td></tr>
<tr>
<td>jm </td><td>integer </td><td>full latitude domain </td></tr>
<tr>
<td></td><td></td><td></td></tr>
<tr>
<td>jsta </td><td>integer </td><td>start latitude on a task subdomain </td></tr>
<tr>
<td>jend </td><td>integer </td><td>end latitude on a task subdomain </td></tr>
<tr>
<td>ista </td><td>integer </td><td>start longitude on a task subdomain </td></tr>
<tr>
<td>iend </td><td>integer </td><td>end longitude on a task subdomain </td></tr>
<tr>
<td></td><td></td><td></td></tr>
<tr>
<td>ista_2l </td><td>integer </td><td>start longitude -2 of the subdomain </td></tr>
<tr>
<td>iend_2u </td><td>integer </td><td>end longitude +2 of the subdomain </td></tr>
<tr>
<td>jsta_2l </td><td>integer </td><td>start latitude -2 of the subdomain </td></tr>
<tr>
<td>jend_2u </td><td>integer </td><td>end latitude +2 of the subdomain </td></tr>
</table>
<p>The shape of the subdomain is ista_2l:iend_2u,jsta_2l:jend_2u so it includes the halos although the halos are not populated until exchange is done in <a class="el" href="EXCH_8f.html" title="Subroutines that exchange one halo row. ">EXCH.f</a>. Because of halos we need more bounds defined:</p>
<table class="doxtable">
<tr>
<th>Variable </th><th>Type </th><th>Description  </th></tr>
<tr>
<td>jsta_m </td><td>integer </td><td>Beginning latitude loop index in subdomain for halo depth 1 </td></tr>
<tr>
<td>jend_m </td><td>integer </td><td>ending latitude loop index in subdomain for halo depth 1 </td></tr>
<tr>
<td>jsta_m2 </td><td>integer </td><td>second latitude below begin latitude of subdomain for halo depth 2 (in <a class="el" href="NGMFLD_8f.html" title="ngmfld() computes layer mean NGM fields ">NGMFLD.f</a>) </td></tr>
<tr>
<td>jend_m2 </td><td>integer </td><td>second latitude above end latitude of subdomain for halo depth 2 ( in <a class="el" href="NGMFLD_8f.html" title="ngmfld() computes layer mean NGM fields ">NGMFLD.f</a>) </td></tr>
</table>
<p>Note:</p>
<ul>
<li>
In interior subdomains these are the same as jsta and jend.</li>
<li>
In boundary subdomains these loop indices define a smaller subset of the subdomain since halos are not defined on the full domain boundaries and stencils must be restricted to valid full domain points. </li>
</ul>
<table class="doxtable">
<tr>
<th>Variable </th><th>Type </th><th>Description  </th></tr>
<tr>
<td>ista_m </td><td>integer </td><td>begining longitude loop index in subdomain for halo depth 1 </td></tr>
<tr>
<td>iend_m </td><td>integer </td><td>end longitude loop index in subdomain for halo depth 1 </td></tr>
<tr>
<td>ista_m2 </td><td>integer </td><td>second longitude before begin longitude for halo depth 2 (not used as of 6/22) </td></tr>
<tr>
<td>iend_m2 </td><td>integer </td><td>second longitude after end longitude for halo depth 2 (not used as of 6/22) </td></tr>
</table>
<p>Note:</p>
<ul>
<li>
In interior subdomains these are the same as ista and iend.</li>
<li>
In boundary subdomains these loop indices define a smaller subset of the subdomain since halos are not defined on the full domain boundaries and stencils must be restricted to valid full domain points.</li>
</ul>
<table class="doxtable">
<tr>
<th>Variable </th><th>Type </th><th>Description  </th></tr>
<tr>
<td>ileft </td><td>integer </td><td>MPI rank containing the last longitude before ista </td></tr>
<tr>
<td>iright </td><td>integer </td><td>MPI rank containing the first longitude after iend </td></tr>
<tr>
<td>iup </td><td>integer </td><td>MPI rank containing the first latitude after jend </td></tr>
<tr>
<td>idn </td><td>integer </td><td>MPI rank containing the last latitude before jsta </td></tr>
<tr>
<td></td><td></td><td></td></tr>
<tr>
<td>ileftb </td><td>integer </td><td>MPI rank containing the last longitude before ista but for cyclic boundary conditions where "last" at the beginning is the other end of the domain (apparently unused and replaced with local calculation) </td></tr>
<tr>
<td>irightb </td><td>integer </td><td>MPI rank containing the first longitude after iend but for cyclic boundary conditions where "first" at the beginning is the other end of the domain (apparently unused and replaced with local calculation) </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
